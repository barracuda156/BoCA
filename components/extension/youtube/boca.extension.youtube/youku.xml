<VideoSite>
  <name>YOUKU.com</name>
  <version>1.0</version>
  <decoder>ffmpeg-flv_audio-in</decoder>

  <script type="text/javascript">
    function canHandleURL(URL) {
      if (URL.toLowerCase().search(/^http:\/\/v\.youku\.com\/v_show\//) != -1) return true;
      else								       return false;
    }

    function getVideoURL(html) {
      var seed;
      var cg_str;

      function ran() {
	seed = (seed * 211 + 30031) % 65536;

	return seed / 65536;
      }

      function cg_hun() {
	cg_str = '';

	var alphabet = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ/\\:._-1234567890';
	var length = alphabet.length;

	for (var i = 0; i &lt; length; i++) {
	  var pos = Math.floor(ran() * alphabet.length);

	  cg_str += alphabet.charAt(pos);

	  alphabet = (alphabet.split(alphabet.charAt(pos))).join('');
	}
      }

      function cg_fun(ids) {
	var array = ids.split('*');
	var result = '';

	for (var i = 0; i &lt; array.length - 1; i++) {
	  result += cg_str.charAt(Number(array[i]));
	}

	return result;
      }

      var sessionID = (new Date()).getTime() + '' + (1000 + (new Date()).getMilliseconds()) + '' + (Math.floor(Math.random() * 9000) + 1000);
      var playlist = eval('(' + downloadURL("http://v.youku.com/player/getPlayList/VideoIDS/" + (html.match(/var\s+videoId2\s*=\s*'(.*?)';/), RegExp.$1)) + ')');

      playlist.data[0].key1 = (Number('0x' + playlist.data[0].key1) ^ Number('0xA55AA5A5')).toString(16);
      seed = playlist.data[0].seed;

      cg_hun();

      var url= 'http://f.youku.com/player/getFlvPath/sid/' + sessionID + '_00/st/flv/fileid/' + cg_fun(playlist.data[0].streamfileids.flv) + '?K=' + playlist.data[0].key2 + playlist.data[0].key1;

      return url;
    }

    function queryMetadata(html) {
      var playlist = eval('(' + downloadURL("http://v.youku.com/player/getPlayList/VideoIDS/" + (html.match(/var\s+videoId2\s*=\s*'(.*?)';/), RegExp.$1)) + ')');
      var metadata = new Metadata();

      metadata.title	   = playlist.data[0].title;
      metadata.description = (html.match(/&lt;div class="info" id="long".*?&gt;(?:.|\n|\r)*?&lt;div class="item"&gt;((?:.|\n|\r)*?)&lt;\/div&gt;/) ? RegExp.$1 : null);

      metadata.thumbnail   = playlist.data[0].logo;

      metadata.uploader	   = playlist.data[0].username;

      return metadata;
    }
  </script>
</VideoSite>
