########## BoCA commands makefile ##########

include $(BOCA_PATH)/Makefile-options

CC     = gcc
CCOPTS = -pipe -g0 -Wall -Os -fvisibility=hidden -DBOCA_COMPONENT_BUILD $(DEFINE) -I$(BOCA_PATH)/include
LD     = gcc
LDOPTS = -pipe -L$(BOCA_PATH)/$(LIBDIR) -lstdc++ $(LIBS)

ifneq ($(EXCEPTION),True)
	CCOPTS += -fno-exceptions
endif

ifeq ($(BUILD_OSX),True)
	LDOPTS += -Wl,-x

ifeq ($(BUILD_X86),True)
	CCOPTS += -arch i386
	LDOPTS += -arch i386
endif
ifeq ($(BUILD_X86_64),True)
	CCOPTS += -arch x86_64
	LDOPTS += -arch x86_64
endif
ifeq ($(BUILD_PPC),True)
	CCOPTS += -arch ppc
	LDOPTS += -arch ppc
endif
ifeq ($(BUILD_PPC64),True)
	CCOPTS += -arch ppc64
	LDOPTS += -arch ppc64
endif
else
	LDOPTS += -s

ifeq ($(BUILD_X86),True)
	CCOPTS += -m32
	LDOPTS += -m32
else ifeq ($(BUILD_X86_64),True)
	CCOPTS += -m64
	LDOPTS += -m64
endif
endif

ifneq ($(BUILD_WIN32),True)
ifneq ($(BUILD_SOLARIS),True)
ifneq ($(BUILD_QNX),True)
ifneq ($(BUILD_HAIKU),True)
	CCOPTS += -pthread
endif
endif
endif
endif

ifeq ($(BUILD_WIN32),True)
	LDOPTS += -lsmooth -lboca -Wl,--dynamicbase,--nxcompat,--enable-auto-import
else
	LDOPTS += -L$(PREFIX)/lib -lsmooth-$(SMOOTHVER) -lboca-$(VERSION)

	ifeq ($(BUILD_SOLARIS),True)
		CCOPTS += -fPIC
		LDOPTS += -Wl,-rpath,.
	else ifeq ($(BUILD_OSX),True)
		LDOPTS += -Wl,-rpath,. -Wl,-headerpad,80
	else ifeq ($(BUILD_LINUX),True)
		ifeq ($(BUILD_X86_64),True)
			CCOPTS += -fPIC
		endif
	else ifeq ($(BUILD_NETBSD),True)
		CCOPTS += -I/usr/pkg/include
		LDOPTS += -Wl,-rpath,/usr/pkg/lib -L/usr/pkg/lib -Wl,-rpath,.
	else ifeq ($(BUILD_HAIKU),True)
		LDOPTS += -L/boot/common/lib -Wl,-rpath,.
	else
		CCOPTS += -I/usr/local/include
		LDOPTS += -L/usr/local/lib -Wl,-rpath,.
	endif
endif

all: allcmds $(BOCA_PATH)/$(BINDIR)/boca_$(TYPE)_$(TARGET).$(VERSION)$(SHARED)

allcmds:
	$(ALLCMD1)
	$(ALLCMD2)

$(BOCA_PATH)/$(BINDIR)/boca_$(TYPE)_$(TARGET).$(VERSION)$(SHARED) : $(OBJECTS)
	mkdir -p $(BOCA_PATH)/$(BINDIR)
ifneq ($(BUILD_OSX),True)
	$(LD) --shared -o $@ $(OBJECTS) $(LDOPTS)
else
	$(LD) -dynamiclib -o $@ $(OBJECTS) $(LDOPTS)
endif

clean:
	rm -f $(BOCA_PATH)/$(BINDIR)/boca_$(TYPE)_$(TARGET).$(VERSION)$(SHARED) $(OBJECTS)
	$(CLEANCMD1)
	$(CLEANCMD2)

install: uninstall
ifneq ($(BUILD_WIN32),True)
	mkdir -p $(PREFIX)/$(LIB)/boca
	cp $(BOCA_PATH)/$(BINDIR)/boca_$(TYPE)_$(TARGET).$(VERSION)$(SHARED) $(PREFIX)/$(LIB)/boca
	chmod a=r,u=rw $(PREFIX)/$(LIB)/boca/boca_$(TYPE)_$(TARGET).$(VERSION)$(SHARED)
endif
	$(INSTCMD1)
	$(INSTCMD2)

uninstall:
ifneq ($(BUILD_WIN32),True)
	rm -f $(PREFIX)/$(LIB)/boca/boca_$(TYPE)_$(TARGET).$(VERSION)$(SHARED)
endif
	$(UINSTCMD1)
	$(UINSTCMD2)

.c.o:
	$(CC) $(CCOPTS) -c $< -o $@

.cpp.o:
	$(CC) $(CCOPTS) -c $< -o $@
